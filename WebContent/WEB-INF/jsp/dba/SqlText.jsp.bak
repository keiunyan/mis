<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="com.jzctb.mis.db.ConnectManager" %>
<%@ page import="java.sql.Connection" %>
<%@ page import="java.sql.PreparedStatement" %>
<%@ page import="java.sql.ResultSet" %>
<%@ page import="java.sql.SQLException" %>
<%@ page import="java.sql.ResultSetMetaData" %>

<!DOCTYPE html>
<html>
<head>
	<title>SQL TEXT</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	
	<!--[if lt IE 9]><script src="js/speedup.js" type="text/javascript"></script><script src="js/jquery-1.11.3.min.js" type="text/javascript"></script><![endif]-->
	<!--[if gte IE 9]><!--><script src="js/jquery-2.1.4.min.js" type="text/javascript"></script><!--<![endif]-->
	
</head>
<body>
<h2>SQL 信息</h2>

<table width="100%" style="word-break:break-all; word-wrap:break-word;
	border-collapse:collapse; border-spacing:0; border:1pxsolid#ccc;" border="1" >
<thead>
	<tr>
		<th width="300">属性</th>
		<th width="800">值</th>
	</tr>
</thead>
<tbody>	
<%
    String dbName = request.getParameter("dbname");
    String sqlId = request.getParameter("sqlid");
    String schema = request.getParameter("schema");
    Connection conn = null;
    PreparedStatement psm = null;
    ResultSet rs = null;
    String sql = "select * from v$sql where sql_id=? and parsing_schema_name=?";
    try {
        conn = ConnectManager.getConnection(dbName);
        psm = conn.prepareStatement(sql); 
        psm.setString(1, sqlId);
        psm.setString(2, schema);
        rs = psm.executeQuery();
        if(rs.next()) {
        	ResultSetMetaData rsmd = rs.getMetaData();
        	for(int i=0; i<rsmd.getColumnCount(); i++) {
        		out.print("<tr><td align='right'>"+rsmd.getColumnLabel(i+1)+"&nbsp;</td><td>&nbsp;"+rs.getString(i+1)+"</td></tr>");
			}
        	ConnectManager.closePreparedStatement(psm);
        }else{
            sql="select sql_text from v$sqltext where sql_id=? order by piece";
            psm = conn.prepareStatement(sql); 
            psm.setString(1, sqlId);
            rs = psm.executeQuery();
            StringBuffer sb = new StringBuffer("");
            
            while(rs.next()){
                sb.append(rs.getString("SQL_TEXT"));
            }
            String sqltext = sb.toString();
            if(!"".equals(sqltext)){
            	out.print("<tr><td>SQL_TEXT</td><td>"+sqltext+"</td></tr>");
            }else{
            	out.print("<tr><td>未找到相关信息</td></tr>");
            }
        }
    }catch(SQLException e) {
        out.println("SQLException:\n" + e);
    }catch(Exception e) {
        out.println("Exception:\n" + e);
    }
    finally{
    	ConnectManager.closeResultSet(rs);
    	ConnectManager.closePreparedStatement(psm);
    	ConnectManager.closeConn(conn);
    }
%>
</tbody>
</table>
    
</body>
</html>
